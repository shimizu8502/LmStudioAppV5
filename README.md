<!-- @format --> 

# LM Studio API クライアント - 改良版 V5
- ドキュメント  
  https://deepwiki.com/shimizu8502/LmStudioAppV5
  

このアプリケーションは、LM Studio の API サーバーにプロンプトを送信し、レスポンスを取得するためのシンプルな Python クライアントです。
**改良版では、プロンプト履歴機能の大幅な改善と、美しい UI デザインが追加されました。**

## ✨ 最新バージョン（V5）の新機能・改良点

### 🎨 GUIデスクトップアプリの大幅刷新（NEW!）
- **🌟 モダンなUIデザイン**: カスタムカラーパレットとスタイリング
- **🔧 カスタムスタイル**: 色分けされたボタン（送信=青、成功=緑、警告=オレンジ、削除=赤）
- **📏 改善されたレイアウト**: 適切なパディング（15px統一）とパネル分離
- **🎯 ツールチップ**: 全ボタンにヘルプテキストを表示
- **⚡ プログレスバー**: 処理中の視覚的フィードバック
- **🖥️ 高DPI対応**: Windows高解像度ディスプレイサポート
- **📱 レスポンシブデザイン**: ウィンドウサイズ調整に対応（最小1000x700）

### 🎪 視覚的な改善
- **カラーパレット**: 現代的なダークブルー＋アクセントカラー
- **タイポグラフィ**: Segoe UI（UI要素）、Consolas（コード入力）
- **アイコン強化**: 各機能に分かりやすい絵文字アイコン
- **カードスタイル**: パネルを立体的なカードデザインに
- **視覚的階層**: タイトル、サブタイトル、ステータスの明確な区別

### ⚡ パフォーマンス表示の改善
- **色分けされた応答時間表示**:
  - ⚡ 1秒未満: 緑色（高速）
  - ⏱️ 1-5秒: オレンジ色（標準）
  - 🐌 5秒以上: 赤色（低速）
- **詳細なエラーメッセージ**: タイムアウト、接続エラーなどを区別
- **非侵襲的な通知**: ステータスバーでのコピー完了通知

### 🔧 操作性の向上
- **リアルタイム文字数カウント**: カンマ区切りで見やすく表示
- **履歴数表示**: 現在の履歴件数をリアルタイム表示
- **スマートな履歴管理**: 右クリックメニューとダブルクリック操作
- **改善されたコピー機能**: ステータスバー通知で確認
- **レスポンスエリアの保護**: 編集不可で表示の一貫性を保持

### 🎯 ユーザビリティの改善
- **確認ダイアログの改善**: アイコン付きで分かりやすく
- **ボタンの視認性**: 黒文字で背景色とのコントラスト改善
- **フォーカス管理**: 適切なキーボードナビゲーション
- **状態表示**: 送信中の視覚的フィードバック

### 🖥️ GUI デスクトップアプリ追加（改良版）
- **デスクトップアプリ版**: ブラウザ不要のネイティブGUIアプリケーション
- **同じ機能**: Web版と全く同じ機能をデスクトップで利用可能
- **統合起動**: 統一ランチャーでWeb版/GUI版を選択可能
- **高速レスポンス**: デスクトップアプリならではの高速な動作
- **ネイティブUI**: tkinterベースの美しくモダンなインターフェース
- **共通履歴**: Web版とGUI版で同じデータベースを共有
- **バージョン表示**: Ver 20250527.1244 を明確に表示

### ⚡ 処理速度の大幅高速化
- **HTTPセッション接続プール**: requests.Sessionを使用した接続再利用で通信速度向上
- **非同期履歴保存**: 履歴保存を別スレッドで処理し、レスポンス速度を向上
- **最適化されたタイムアウト設定**: 接続5秒、読み取り120秒の適切なタイムアウト
- **JSON処理最適化**: json.dumps()を省略したデータ送信で高速化
- **リアルタイム性能測定**: レスポンス時間をミリ秒単位で表示
- **視覚的フィードバック**: 処理中のアニメーション効果で待機時間を短く感じさせる

### 🎯 プロンプト履歴の大幅改善
- **📏 拡張されたサイドバー**: 450px の広い履歴エリア
- **⏰ タイムスタンプ表示**: 「5分前」「1時間前」などの相対時刻
- **✂️ スマートプレビュー**: 長いプロンプトは自動切り詰め、クリックで展開
- **🎨 視覚的改善**: カラフルなバッジとアニメーション効果
- **💾 完全な履歴保存**: プロンプトと回答の両方をデータベースに保存
- **🔍 質問と回答の分離表示**: 質問は青、回答は緑で視覚的に区別

### 📋 コピー機能
- **📋 メイン回答コピー**: 生成された回答にワンクリックでコピーボタン表示
- **📑 履歴コピー**: 各履歴項目の回答に小さなコピーボタンを配置
- **✅ 視覚的フィードバック**: コピー成功時の色変更とメッセージ表示
- **🛡️ 互換性**: 最新ブラウザとレガシーブラウザの両方に対応

### 🎪 UI/UX の向上
- **🌈 グラデーション背景**: 美しいグラデーション背景とカードデザイン
- **🤖 アイコン**: 各セクションに分かりやすいアイコンを追加
- **💫 アニメーション**: ホバー効果とスムーズな遷移
- **📱 レスポンシブデザイン**: モバイル端末での完全対応

### ⚡ 操作性の向上
- **🎯 スマートスクロール**: アクションに応じて適切な位置にスクロール
- **📊 リアルタイム情報**: 文字数カウント、履歴件数表示
- **🔔 詳細なフィードバック**: 絵文字付きの分かりやすいステータス
- **⚠️ 確認ダイアログ**: 重要な操作前に確認メッセージを表示
- **🚀 安全な送信機能**: 送信ボタンのみで送信、Enterキーでの誤送信を防止

## 機能

### 🔧 基本機能
- 利用可能なモデルの一覧表示
- チャット完了 API（chat/completions）の使用
- テキスト完了 API（completions）の使用
- **2つのインターフェース**: Web ブラウザ版とGUI デスクトップ版をサポート
- **統合ランチャー**: 使いたいバージョンを選択して起動可能

### 📝 履歴管理機能
- **プロンプトと回答の保存**: 送信したプロンプトとAIの回答をSQLiteデータベースに自動保存
- **🌐 IPアドレス別管理**: 接続元のIPアドレスごとに履歴を分離管理
- **個別表示**: 現在接続しているPCの履歴のみを表示
- **履歴の視覚的表示**: 質問（青）と回答（緑）を色分けして表示
- **スマートプレビュー**: 長いテキストは自動で切り詰め、クリックで全文表示
- **履歴の再利用**: 過去のプロンプトをワンクリックで再利用
- **編集機能**: 履歴からプロンプトを読み込んで編集可能
- **個別削除**: 不要な履歴項目を個別に削除
- **一括削除**: 現在のPCの履歴をまとめてクリア

### 📋 コピー機能
- **回答のコピー**: 生成された回答をワンクリックでクリップボードにコピー
- **履歴のコピー**: 過去の回答もコピー可能
- **フォールバック対応**: 古いブラウザでも動作する互換性機能
- **視覚的フィードバック**: コピー成功時の色変更とメッセージ表示

## ⚙️ 設定

### 📡 API サーバー設定

アプリケーションは **`ipconfig.ini`** ファイルからLM Studio APIサーバーの設定を読み込みます。

#### 初回起動時
- 初回起動時に `ipconfig.ini` ファイルが自動作成されます
- デフォルト設定: `192.168.1.166:1234`

#### 設定ファイルの内容例
```ini
[API_SERVER]
# LM Studio API サーバーのIPアドレスとポートを設定してください
# デフォルト値: 192.168.1.166:1234
ip = 192.168.1.166
port = 1234

# 設定例:
# ip = 192.168.1.100
# ip = localhost
# port = 1234
```

#### 設定変更方法
1. **テキストエディタで編集**: `ipconfig.ini` ファイルをメモ帳などで開く
2. **IPアドレス変更**: `ip = 新しいIPアドレス` に変更
3. **ポート変更**: `port = 新しいポート番号` に変更  
4. **アプリケーション再起動**: 変更を反映するために再起動

#### よく使う設定例
- **ローカル**: `ip = localhost` または `ip = 127.0.0.1`
- **同一PC**: `ip = localhost`、`port = 1234`
- **別PC**: `ip = 192.168.1.100`、`port = 1234`

## 📁 ファイル構成

```
LmStudioAppV5/
├── 📄 web_app.py              # Webアプリケーション本体
├── 📄 gui_app.py              # GUIデスクトップアプリ本体（モダンデザイン）
├── 📁 templates/              # HTMLテンプレート
│   └── index.html             # メインページ
├── 📁 static/                 # 静的ファイル
│   ├── style.css              # スタイルシート
│   └── script.js              # JavaScript
├── ⚙️ ipconfig.ini            # API サーバー設定ファイル（自動生成）
├── 📄 prompt_history.db       # SQLiteデータベース（自動生成）
├── 📄 requirements.txt        # Python依存関係（pyperclip追加）
├── 📄 README.md               # このファイル
├── 🔧 install_web.bat         # Windowsインストールスクリプト
├── 🔧 install_web.ps1         # PowerShellインストールスクリプト
├── 🚀 run_app.bat             # 統合ランチャー
├── 🚀 run_web.bat             # Web版実行スクリプト
├── 🚀 run_gui.bat             # GUI版実行スクリプト（モダンデザイン）
├── 🚀 run_web_debug.bat       # Web版デバッグモード
└── 🚀 run_web.ps1             # PowerShell実行スクリプト
```

## 💾 データベース構造

アプリケーションはSQLiteデータベース（`prompt_history.db`）を使用して履歴を保存します：

```sql
CREATE TABLE prompt_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    prompt TEXT NOT NULL,           -- 送信されたプロンプト
    response TEXT,                  -- AIの回答
    api_type TEXT NOT NULL,         -- 'chat' または 'text'
    timestamp TEXT NOT NULL,        -- ISO形式のタイムスタンプ
    client_ip TEXT                  -- 接続元IPアドレス
);
```

- **自動作成**: 初回起動時にデータベースとテーブルが自動生成
- **マイグレーション**: 既存データベースに新しい列を自動追加
- **SQLite**: ファイルベースでポータブル、バックアップが簡単
- **IPアドレス管理**: 接続元IPごとに履歴を分離保存

## インストール方法

### 🚀 簡単インストール（推奨）

#### Windows（バッチファイル版）
1. **`install_web.bat`** をダブルクリックして実行します
2. 自動的に仮想環境を作成し、必要なライブラリをインストールします
3. インストール完了後、以下の方法でアプリケーションを起動できます：
   - **`run_app.bat`** - 統合ランチャー（推奨・両版選択可能）🆕
   - **`run_web.bat`** - Web版直接起動（プロダクションモード・高速）
   - **`run_gui.bat`** - GUI版直接起動（モダンデザイン・デスクトップアプリ）🆕
   - **`run_web_debug.bat`** - Web版デバッグモード（開発用）

#### 必要なライブラリ
```bash
pip install flask==2.3.3 requests==2.31.0 pyperclip
```

- **pyperclip**: クリップボード操作に必要（GUIアプリ用）
- **tkinter**: Python標準ライブラリ（通常は追加インストール不要）

#### Windows（PowerShell版）
1. **`install_web.ps1`** を右クリック → PowerShell で実行
2. より詳細なログとエラーハンドリングが提供されます
3. インストール完了後、**`run_web.ps1`** でアプリケーションを起動できます

### 📋 利用可能なスクリプト

| ファイル名 | 用途 | 特徴 |
|----------|------|------|
| `install_web.bat` | インストール | シンプルで確実なバッチファイル |
| `install_web.ps1` | インストール | PowerShell版、詳細なログ |
| `run_app.bat` | 統合ランチャー | **推奨**: Web版/GUI版選択可能 🆕 |
| `run_web.bat` | Web版の実行（本番） | プロダクションモード、高速化機能 |
| `run_gui.bat` | GUI版の実行 | モダンデザイン・デスクトップアプリ 🆕 |
| `run_web_debug.bat` | Web版の実行（開発） | デバッグモード、自動リロード |
| `run_web.ps1` | Web版の実行 | PowerShell版、ネットワーク情報表示 |

### 🔧 PowerShell スクリプトの実行ポリシー

PowerShell スクリプトが実行できない場合は、以下のコマンドを管理者権限で実行してください：

```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 手動インストール

1. 仮想環境を作成：
```bash
python -m venv venv
```

2. 仮想環境をアクティベート：
```bash
# Windows
venv\Scripts\activate

# Mac/Linux
source venv/bin/activate
```

3. 必要なライブラリをインストール：
```bash
pip install flask==2.3.3 requests==2.31.0 pyperclip
```

## 使用方法

### 🚀 統合ランチャー（最も簡単）

#### 推奨方法
- **`run_app.bat`** をダブルクリック
- メニューから使いたいバージョンを選択：
  1. 🌐 Web ブラウザ版 - http://localhost:8000
  2. 💻 GUI デスクトップ版 - モダンデザインのネイティブアプリ
  3. 🔧 インストール/更新
  4. 📖 ヘルプ

### 🌐 Web バージョン

#### 自動起動
- **`run_web.bat`** または **`run_web.ps1`** をダブルクリック
- ブラウザで **http://localhost:8000** にアクセス

### 💻 GUI デスクトップ版（モダンデザイン）

#### 自動起動
- **`run_gui.bat`** をダブルクリック
- モダンなデザインのデスクトップアプリが直接開きます

#### 手動起動
```bash
# 仮想環境をアクティベート
venv\Scripts\activate

# GUIアプリケーションを起動
python gui_app.py
```

### 📱 Web インターフェースの使い方

1. **モデル選択**: 利用可能なモデルから選択
2. **パラメータ調整**: Temperature や最大トークン数を設定
3. **API タイプ選択**: チャット完了 API またはテキスト完了 API
4. **プロンプト入力**: テキストエリアにプロンプトを入力
   - **送信方法**: 🚀 送信ボタンのみで送信（**Enterキーでは送信されません**）
   - **改行**: Enterキーまたは Shift + Enter で改行が可能
5. **送信**: 🚀 送信ボタンをクリック
6. **履歴活用**: 左サイドバーから過去のプロンプトを再利用

### 💻 GUI デスクトップアプリの使い方（モダンデザイン）

#### 🎨 新しいモダンなUIの特徴
- **カラーコーディング**: 機能別に色分けされたボタン
  - 🚀 送信ボタン: 青色（プライマリー）
  - ✅ 更新・コピーボタン: 緑色（成功）
  - ⚠️ クリアボタン: オレンジ色（警告）
  - ❌ 削除ボタン: 赤色（危険）
- **ツールチップ**: 各ボタンにカーソルを合わせるとヘルプが表示
- **プログレスバー**: 処理中に進行状況を視覚的に表示
- **高DPI対応**: 高解像度ディスプレイで美しく表示

#### 基本操作
1. **モデル選択**: ドロップダウンから利用可能なモデルを選択
2. **パラメータ調整**: スライダーとスピンボックスで詳細設定
   - **Temperature**: スライダーで直感的に調整、リアルタイム値表示
   - **Max Tokens**: スピンボックスで正確な値設定（100-8000）
3. **API タイプ選択**: ラジオボタンでChat/Textを選択（ツールチップ付き）
4. **プロンプト入力**: 
   - モダンなフォント（Consolas）で見やすい入力
   - リアルタイム文字数カウント（カンマ区切り）
   - **送信方法**: 🚀 送信ボタンのみで送信（**Enterキーでは送信されません**）
   - **改行**: Enterキーまたは Shift + Enter で改行が可能
5. **送信**: 🚀 送信ボタンをクリック
   - 送信中はプログレスバーとボタン状態変更で視覚的フィードバック
6. **履歴活用**: 
   - 左パネルの美しく整理された履歴ツリーから選択
   - 履歴件数のリアルタイム表示
7. **右クリックメニュー**: 履歴項目で右クリックして各種操作
8. **コピー機能**: 📋 コピーボタンでクリップボードにコピー
   - コピー成功時はステータスバーに通知（3秒間）

#### 🎯 応答時間の色分け表示
- ⚡ **1秒未満**: 緑色（高速）
- ⏱️ **1-5秒**: オレンジ色（標準）
- 🐌 **5秒以上**: 赤色（低速）

### 🎨 改良されたプロンプト履歴機能

- **📅 時間表示**: 「たった今」「5分前」「1時間前」などの相対時刻
- **✂️ 自動省略**: 長いプロンプトは150文字、回答は100文字で切り詰め、クリックで全文表示
- **🏷️ API タイプ**: チャット/テキスト API の種類をバッジで表示
- **🎨 色分け表示**: 質問は青色、回答は緑色で視覚的に区別
- **🌐 IPアドレス表示**: 現在の接続元IPアドレスをサイドバー上部に表示
- **📊 履歴分離**: 異なるPCからアクセスしても、それぞれの履歴は独立
- **⚡ クイックアクション**: 
  - ✅ 使用: プロンプトと回答を入力・出力エリアに設定
  - ✏️ 編集: プロンプトを編集モードで読み込み（履歴は保持）
  - 🗑️ 削除: 履歴から削除（現在のPCのもののみ）
  - 📋 コピー: 回答をクリップボードにコピー

### 📋 コピー機能の詳細

- **メイン回答エリア**: 
  - 回答生成時に自動的にコピーボタンが表示
  - 「📋 コピー」ボタンをクリックでワンクリックコピー
  - コピー成功時にステータスバーで確認（3秒間）

- **履歴エリア**: 
  - 各回答に小さな「📋」ボタンを配置
  - 回答がない履歴項目には非表示
  - コピーボタンクリック時は展開/折りたたみ動作を停止

- **技術仕様**:
  - GUI版: `pyperclip`ライブラリを使用した確実なコピー
  - Web版: `navigator.clipboard.writeText()` API使用
  - レガシーブラウザ: `document.execCommand('copy')` フォールバック
  - 文字数カウント機能付き
  - エラーハンドリング完備

### Windows（バッチファイルを使用）

- GUI バージョンを実行するには：`run_gui.bat` をダブルクリックします。
- Web バージョンを実行するには：`run_web.bat` をダブルクリックします。

## ⚠️ 注意事項

### 前提条件
- **LM Studio の API サーバーが実行されていることを確認してください**
- モデル名を空白のままにすると、LM Studio で現在ロードされているモデルが使用されます
- **API サーバー設定**: 初回起動時に `ipconfig.ini` が自動作成されます

### システム要件
- Python 3.7 以上
- **GUI バージョン**: 
  - tkinter（Python標準ライブラリ、通常は追加インストール不要）
  - pyperclip（クリップボード操作用）
- **Web バージョン**: Flask（`requirements.txt` に含まれています）
- **高DPI対応**: Windows 10/11での高解像度ディスプレイサポート

### データとプライバシー
- **履歴データ**: プロンプトと回答は `prompt_history.db` に保存されます
- **ローカル保存**: すべてのデータはローカルマシンに保存され、外部に送信されません
- **バックアップ**: データベースファイルをコピーするだけで履歴をバックアップできます
- **削除**: アプリ内から履歴を削除、またはデータベースファイルを削除

### セキュリティ
- **ネットワーク公開**: Web版は `0.0.0.0:8000` で起動するため、同一ネットワーク内からアクセス可能
- **本番利用**: 本番環境では適切な認証機能の追加を検討してください
- **ファイアウォール**: 必要に応じてポート8000の公開範囲を制限してください

### トラブルシューティング

#### 🌐 Web版
- **コピー機能が動作しない**: HTTPS接続または最新ブラウザの使用を推奨
- **履歴が表示されない**: データベースファイルの権限を確認してください
- **レスポンスが遅い**: プロダクションモード（`run_web.bat`）を使用

#### 💻 GUI版（モダンデザイン）
- **pyperclipエラー**: `pip install pyperclip` を実行
- **tkinterエラー**: Python標準インストールを確認（通常は含まれています）
- **GUIが開かない**: 仮想環境のアクティベーションを確認
- **コピー機能が動作しない**: pyperclipライブラリの再インストールを試行
- **ボタンの文字が見えない**: 最新版では黒文字で修正済み
- **高DPIで表示が小さい**: アプリケーション側で自動対応済み
- **ツールチップが表示されない**: 各ボタンにカーソルを合わせてください

#### 🔧 共通
- **API接続エラー**: 
  - LM Studio APIサーバーが起動しているか確認
  - `ipconfig.ini` ファイルのIPアドレスとポートを確認
  - アプリケーション再起動を試行
- **設定ファイルエラー**: `ipconfig.ini` を削除して再起動すると初期設定で再作成されます
- **履歴保存エラーが多発する**: 
  - データベースファイル `prompt_history.db` の権限を確認
  - ディスク容量を確認
- **ライブラリエラー**: `install_web.bat` を再実行
- **送信操作について**:
  - **Enterキーでは送信されません** - 必ず 🚀 送信ボタンをクリックしてください

## 📈 バージョン履歴

### V5 (2025/01/27) - モダンUIデザイン大刷新
- 🎨 GUIアプリケーションの大幅なビジュアル改善
- 🌟 カスタムカラーパレットとモダンなスタイリング
- 🔧 色分けされたボタンとツールチップ機能
- ⚡ プログレスバーと高DPI対応
- 📏 改善されたレイアウトとタイポグラフィ
- 🎯 ユーザビリティの大幅向上
- 🛡️ エラーハンドリングとフィードバックの改善

### V4 (2025/01/XX) - GUI デスクトップアプリ追加
- 💻 tkinterベースのネイティブGUIアプリケーション
- 🚀 統合ランチャーでWeb版/GUI版選択可能
- 📋 pyperclipを使用したクリップボード機能

### V3 (2024/XX/XX) - 履歴機能とUI改善
- 📝 プロンプト履歴機能の追加
- 🎨 UI/UXの大幅改善
- ⚡ パフォーマンスの最適化

---

**🎉 最新版（V5）では、特にGUIアプリケーションの見た目と使いやすさが大幅に向上しました！**


